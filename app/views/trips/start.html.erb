<div class="wrapper">
  <div class="container">
    <div class="row">
      <h1>Listing experiences</h1>
    </div>
    <div class="row">
      <div class="col-xs-12 col-sm-9">
        <div class="map-checkbox">
            <label>
              <input id="checkbox" type="checkbox" class="map-checkbox-input">
              <small>Only show my experiences</small>
            </label>
        </div>
        <div id="map">
        </div>
      </div>
      <div class="col-xs-12 col-sm-3">
        <ul id="draggablePanelList" class="list-unstyled">
        </ul>
        <div id="set-orders" class="btn btn-primary">
          <%= form_for(@trip) do |f| %>
            <%= hidden_field_tag :order %>
            <%= f.submit('Save') %>
          <% end %>
        </div>
      </div>
    </div>
    <div class="row">
      <table>
          <thead>
            <tr>
              <th colspan="3"></th>
            </tr>
          </thead>
          <tbody>
            <% if @experiences %>
              <% @experiences.each do |experience| %>
                <tr>
                  <td><%= experience.name %></td>
                  <td><%= link_to 'Show', experience %></td>
                  <td><%= link_to 'Edit', edit_experience_path(experience) %></td>
                  <td><%= link_to 'Destroy', experience, method: :delete, data: { confirm: 'Are you sure?' } %></td>
                </tr>
              <% end %>
            <%end%>
          </tbody>
        </table>

    </div>
    <div class="row">
      <%= link_to 'New Experience', new_experience_path %>
    </div>
  </div>
</div>




<%= content_for(:before_js) do %>
  <%= javascript_include_tag "https://maps.google.com/maps/api/js?sensor=false" %>
  <%= javascript_include_tag "https://google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js"%>
<% end %>

<% content_for(:after_js) do %>
  <%= javascript_tag do %>
    $(document).on('ready', function() {

      // Generate map
      var mapOptions = {
        center: new google.maps.LatLng(<%= @trip.query_lat %>, <%= @trip.query_lng %>),
        zoom: 6
      };
      buildMap(mapOptions, <%= @trip.id %>);

      // Display existing trip_experiences
      <% if @trip_exp_tab.size > 0 %>
        <% @trip_exp_tab.each do |trip_exp| %>
          var tmpl =
          '<li class="panel panel-info" id="<%= trip_exp.id %>">' +
            '<div class="panel-heading"><%= trip_exp.experience.name %>' +
              '<%= form_tag trip_trip_experience_path(trip_exp.trip, trip_exp), remote: true, method: :delete, class: "form-inline pull-right" do %>'+
                '<%= submit_tag "X", class: "exp-rm-btn" %>' +
              '<% end %>' +
            '</div>'+
            '<div class="panel-body"><%= trip_exp.experience.description %></div>'+
          '</li>';

          $('#draggablePanelList').append(tmpl);
        <% end %>
      <% end %>

      // Send experiences order to trip-experiences controller
      $('#set-orders').on("mousedown", function() {
        var order = {};
        for (var i = 0; i < $('.panel.panel-info').length; i++){
          order[i+1] =  $('.panel.panel-info')[i].id;
        }
        $('#order').attr('value', JSON.stringify(order));
      });
    });
  <% end %>
<% end %>