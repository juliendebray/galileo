<body class="wrapper">

<div id="titleblock" class="text-center">
  <% if @guest_user %>
    <h2>Thank you for your tips!!</h2>
  <% else %>
    <h2><%= t('.title', :default => "Design your trip")%> </h2>
  <% end %>
</div>

<div class="row">
  <div class="col-xs-12 col-sm-9">
    <% unless @guest_user %>
      <div id="user-choices">
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="all-experiences" value="1" checked >
          <small>Best experiences</small>
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="user-experiences" value="2">
          <small>My selection</small>
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="guests-comments" value="3">
          <small>My friends' tips</small>
        </label>
      </div>
    <% end %>
  </div>
  <div class="col-xs-12 col-sm-9">
    <div id="map">
    </div>
  </div>
  <div class="col-xs-12 col-sm-3">
    <ul id="draggablePanelList" class="list-unstyled scrollable">
    </ul>
    <% unless @guest_user %>
      <div id="set-orders">
        <%= form_for @trip, url: {action: "update"} do |f|%>
          <%= hidden_field_tag :order %>
          <%= f.submit('Save', class: "btn btn-primary") %>
        <% end %>
      </div>
    <% else %>
      <div id="set-orders">
        <%= form_for @trip, url: {action: "update"} do |f|%>
          <%= hidden_field_tag :order %>
          <%= f.submit('Save my comments', class: "btn btn-group-lg btn-primary") %>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<% unless @guest_user %>
  <!-- Modal: add experience for  user-->

  <!-- Button trigger modal -->
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModal">
    Add an experience
  </button></br>

  <!-- Modal -->
  <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <h4 class="modal-title" id="myModalLabel">Do you want to add your own experience?</h4>
        </div>
        <div class="modal-body">
          <%= render 'form' %>
        </div>
      </div>
    </div>
  </div>

<% end %>

<% unless @guest_user %>
  <a class="btn btn-social btn-facebook" id="sharefb">
    <i class="fa fa-facebook"></i> Ask your friends on Facebook
  </a>

  <%= form_for @trip, url: share_trip_path(@trip.id), remote: true do |f| %>
    <%= hidden_field_tag :id, value = @trip.id %>

    <%= f.submit('Ask your friends by email', class:'btn btn-primary') %>
  <% end %>

<% end %>


<% if @guest_user %>
<!-- Modal: add experience for  user-->

  <!-- Button trigger modal -->
  <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#myModalGuest">
    Add a tip
  </button>

  <!-- Modal -->
  <div class="modal fade" id="myModalGuest" tabindex="-1" role="dialog" aria-labelledby="myModalGuestLabel" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
          <h4 class="modal-title" id="myModalGuestLabel">Share your experiences!</h4>
        </div>
        <div class="modal-body">
          <%= render 'form_guest' %>
        </div>
      </div>
    </div>
  </div>

<% end %>

<% if @guest_user %>
  <div id="trip-comments" class="in-line">
    <ul id="trip-comments-list">
    </ul>
  </div>
<% end %>
</body>


<%= content_for(:before_js) do %>
  <%= javascript_include_tag "https://maps.google.com/maps/api/js?sensor=false&libraries=places&amp;key=AIzaSyCf77HD5LQkLbAcZWkBXKj-DLkXQJ9vHEc" %>
  <%= javascript_include_tag "https://google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js"%>

  <script>
    // Use of a global variable to know if the user is authentificated or guest
    var GUEST_USER = <%= @guest_user ? 'true' : 'false' %>;
  </script>
<% end %>



<% content_for(:after_js) do %>
  <script>
    $(document).on('ready', function() {
      // Display existing trip_experiences
      <% if @trip_exp_tab &&  @trip_exp_tab.size > 0 %>
        <% @trip_exp_tab.each do |trip_exp| %>
          <% if trip_exp.experience %>
            $('#draggablePanelList').append('<%= j render("/trip_experiences/experience_block.html.erb", {trip_exp: trip_exp, guest_user: @guest_user} ) %>');
          <% end %>
        <% end %>
      <% end %>

      if (GUEST_USER) {
        var guestUserMapOptions = {
          disableDoubleClickZoom: false
        };
        buildMapForGuestUser(guestUserMapOptions, <%= @trip.id %>);
        // Remove cursor css on panel heading and remove submit btn
        $('#draggablePanelList .panel-heading').css('cursor', 'auto')
      } else {
        var userMapOptions = {
          center: new google.maps.LatLng(<%= @trip.query_lat %>, <%= @trip.query_lng %>),
          zoom: 6,
          disableDoubleClickZoom: false
        };
        buildMapForUser(userMapOptions, <%= @trip.id %>);
        makeExperiencesSortable();
        setExperiencesOrderByClickingOnSave();
        publishPostOnFbWall("#sharefb", "<%= j share_url("/trips/#{@trip.id}/#{@trip.token}") %>");
      }
    });
  </script>
<% end %>