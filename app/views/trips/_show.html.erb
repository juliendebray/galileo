<% content_for :map_css do %>
<%= stylesheet_link_tag 'map' %>
<% end %>

<div class="wrapper">
  <div class="map-container">
    <div id="map">
    </div>
    <div id='map-interaction'>
      <fieldset id="search-bar">
        <i class="fa fa-search"></i>
        <%= search_field_tag('pac-input') %>
      </fieldset>
      <% unless @guest_user %>
      <div id="user-choices">
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="user-experiences" value="2" <%= "checked" if @trip.trip_comments.empty? && @trip.trip_experiences.any? %>>
          <small><i class="fa fa-map-marker"></i> <%= t('show_myselection') %></small>
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="guests-comments" value="3" <%= "checked" if @trip.trip_comments.any? %>>
          <small><i class="fa fa-comments"></i> <%= t('show_friendstips') %></small>
        </label>
        <label class="radio-inline">
          <input type="radio" name="inlineRadioOptions" id="all-experiences" value="1"  <%= "checked" if @trip.trip_comments.empty? && @trip.trip_experiences.empty? %> >
          <small><i class="fa fa-star"></i> <%= t('show_bestexp') %></small>
        </label>
      </div>
      <% end %>
    </div>
    <% unless @guest_user %>
    <!-- User Modal to let him add his own experience -->
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-default map-bottom-btn" data-toggle="modal" data-target="#myModal" id="new-exp" >
      <small><%= t('show_addmyexp') %></small>
    </button>
    <% else %>
    <!-- Guest Modal to let him add his own experience -->
    <!-- Button trigger modal -->
    <button type="button" class="btn btn-default map-bottom-btn" data-toggle="modal" data-target="#myModalGuest">
      <small><%= t('show_addcomment') %></small>
    </button>
    <% end %>
  </div>
  <div class="sidebar">
    <div class="selection-header text-center">
      <table>
        <tbody>
          <% unless @guest_user %>
            <td>
              <div id="share-bt" class="button-action update-order">
                <%= link_to trip_ask_your_friends_path(@trip), onclick: "ga('send', 'event', 'User', 'Ask advice', 'Ask advice button clicked');", class: "btn btn-facebook btn-block", data: {toggle: "tooltip", placement: "bottom",  title: t('show_asktips')}  do %>
                  <i class="fa fa-comments"></i>
                <% end %>
              </div>
            </td>
            <td>
              <div id="see-trip-summary" class="button-action update-order">
                <%= link_to  summarize_trip_path(@trip), onclick: "ga('send', 'event', 'User', 'See trip summary', 'Show trip summary button clicked');", class: "btn btn-warning btn-block", data: {toggle: "tooltip", placement: "bottom",  title: t('show_summary'), json: 'data'} do %>
                <i class="fa fa-book"></i>
                <% end %>
              </div>
            </td>
            <% if @trip.query && @trip.query.downcase.match('maroc') %>
              <td>
                <div id="see-providers" class="button-action update-order">
                  <%= link_to  providers_trip_path(@trip), onclick: "ga('send', 'event', 'User', 'See providers', 'Show local providers button clicked');", class: "btn btn-default btn-block", data: {toggle: "tooltip", placement: "bottom",  title: t('show_seeproviders')} do %>
                  <i class="fa fa-plus"></i>
                  <% end %>
                </div>
              </td>
            <% end %>
            <% else %>
            <td>
              <div id="set-orders" class="button-action text-center">
                <%= form_for @trip, url: notif_trip_path(@trip.id), remote: true do |f|%>
                <%= f.submit( t('show_saveguest'), onclick: "ga('send', 'event', 'Guest user', 'Share comments', 'Save my comments button clicked');", class: "btn btn-info btn-block") %>
                <% end %>
              </div>
            </td>
          <% end %>
        </tbody>
      </table>
      <div class="selection-title text-center">
      <i class="fa fa-map-marker"></i> <%= t('show_selectedexp') %> <i class="fa fa-angle-down"></i>
      </div>
    </div>
    <div class="selection-content">
      <ul id="draggablePanelList" class="list-unstyled">
        <% if @trip_exp_tab &&  @trip_exp_tab.size > 0 %>
          <% @trip_exp_tab.each do |trip_exp| %>
            <% if trip_exp.experience %>
            <%= render("/trip_experiences/experience_block.html.erb", {trip_exp: trip_exp, guest_user: @guest_user} ) %>
            <% end %>
          <% end %>
        <% end %>
      </ul>
    </div>
  </div>
</div>

<!-- Experience Modal to display -->
<div class="modal fade" id="myExperienceModal" tabindex="-1" role="dialog" aria-labelledby="myExperienceModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
        <h4 class="modal-title experience-title" id="myExperienceModalLabel">Chargement...</h4>
      </div>
      <div class="modal-body experience-content">
      </div>
    </div>
  </div>
</div>

<%= content_for(:before_js) do %>
<%= javascript_include_tag "https://maps.google.com/maps/api/js?sensor=false&libraries=places&amp;key=AIzaSyCf77HD5LQkLbAcZWkBXKj-DLkXQJ9vHEc" %>
<%= javascript_include_tag "https://google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js"%>
<%= javascript_include_tag "//google-maps-utility-library-v3.googlecode.com/svn/tags/infobox/1.1.9/src/infobox_packed.js" %>
<script>
    // Use of a global variable to know if the user is authentificated or guest
    var GUEST_USER = <%= @guest_user ? 'true' : 'false' %>;
    </script>
    <% end %>

    <% content_for(:after_js) do %>
    <script>
    $(document).on('ready', function() {
      $(window).load(function() {
        var length = $(".exp-dotdotdot").length
        if (length != 0) {
          $(".exp-dotdotdot").each(function(index) {
            $( this ).dotdotdot({
              watch: "window",
              callback  : function( isTruncated, orgContent ) {
                if (isTruncated) {
                  $( "p", this ).append(orgContent.find('a.readmore').prop('outerHTML'));
                }
                if (index == length-1) {
                  $('.selection-content').css('visibility', 'visible');
                }
              }
            });
          });
        } else {
          $('.selection-content').css('visibility', 'visible');
        }
      });

      if (GUEST_USER) {
        var guestUserMapOptions = {
          center: new google.maps.LatLng(<%= @trip.latitude %>, <%= @trip.longitude %>),
          zoom: 6,
          disableDoubleClickZoom: false,
          panControl: false,
          zoomControl: true,
          zoomControlOptions: {
            style: google.maps.ZoomControlStyle.SMALL
          }
        };
        buildMapForGuestUser(guestUserMapOptions, <%= @trip.id %>);
        // Remove cursor css on panel heading and remove submit btn
        $('#draggablePanelList .panel-heading').css('cursor', 'auto')
      } else {
        var userMapOptions = {
          center: new google.maps.LatLng(<%= @trip.latitude %>, <%= @trip.longitude %>),
          zoom: 6,
          disableDoubleClickZoom: false,
          disableDefaultUI: true,
          zoomControl: true,
          zoomControlOptions: {
            style: google.maps.ZoomControlStyle.SMALL
          }
          // panControl: false,
          // zoomControl: true,
          // zoomControlOptions: {
          //   style: google.maps.ZoomControlStyle.SMALL
          // }
        };
        buildMapForUser(userMapOptions, <%= @trip.id %>);
        makeExperiencesSortable();
        setExperiencesOrderByEndDraggingAnExperience(<%= @trip.id %>);
        // Tooltip initialization
        // $('[data-toggle="popover"]').popover();
        $('[data-toggle="tooltip"]').tooltip()
      }
    });
</script>
<% end %>
