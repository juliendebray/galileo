// Needed objects to acess to the google maps object
var handler;
var markers = {};

function buildMapForUser(mapOptions, trip_id) {
  handler = Gmaps.build('Google');
  var requestingMarkers = false;
  handler.buildMap({ provider: mapOptions, internal: { id: 'map' } }, function(){
    var map = handler.getMap();
    // SET MARKERS ON MAP LOADING AND KEEP LISTENING
    setMarkersAndKeepListening(map, trip_id);
    // SET MARKERS DEPENDING ON USER CHOICE
    $('#user-choices').on("change", function() {
      if ($('#user-experiences').prop('checked')){
        // Set map with booked experiences;
        google.maps.event.clearListeners(map);
        requestingMarkers = true;
        var url = "/trips/"+trip_id+"/trip_experiences/trip_markers";
        setMarkersAccordingToApi(url, function(r) {
          requestingMarkers = r;
        });
      } else if ($('#guests-comments').prop('checked')) {
        // Set map with trip_comments;
        google.maps.event.clearListeners(map);
        requestingMarkers = true;
        var url = "/trips/"+trip_id+"/trip_comments/comments_markers";
        setMarkersAccordingToApi(url, function(r) {
          requestingMarkers = r;
        });
      } else if ($('#all-experiences').prop('checked')) {
        setMarkersAndKeepListening(map, trip_id);
      }
    });
  });
};

function setMarkersAndKeepListening(map, trip_id) {
  // SET MARKERS ON MAP LOADING AND KEEP LISTENING
  // Set markers on loading
  requestingMarkers = true;
  setMarkersAccordingToBounds(map, trip_id, function(r) {
   requestingMarkers = r;
  });
  // Set markers when drag ends
  google.maps.event.addListener(map, 'dragend', function() {
   google.maps.event.addListener(map, 'idle', function() {
     if (requestingMarkers) {
     return;
     }
     requestingMarkers = true;
     setMarkersAccordingToBounds(map, trip_id, function(r) {
       requestingMarkers = r;
     });
   });
  });
  // Set markers when zoom changes
  google.maps.event.addListener(map, 'zoom_changed', function() {
   google.maps.event.addListener(map, 'idle', function() {
     if (requestingMarkers) {
       return;
     }
     requestingMarkers = true;
     setMarkersAccordingToBounds(map, trip_id, function(r) {
       requestingMarkers = r;
     });
   });
  });
}

function setMarkersAccordingToBounds(map, trip_id, callback) {
  var url = buildUrlWithBounds(map, trip_id);
  setMarkersAccordingToApi(url, callback);
}

function setMarkersAccordingToApi(url, callback) {
  $.get(url, function(data) {
    handler.removeMarkers(markers);
    markers = handler.addMarkers(data);
    handler.bounds.extendWith(markers);
    callback(false);
  });
}

function buildUrlWithBounds(map, trip_id) {
  var bounds = map.getBounds();
  var northEastLat = bounds.getNorthEast().lat();
  var northEastLng = bounds.getNorthEast().lng();
  var southWestLat = bounds.getSouthWest().lat();
  var southWestLng = bounds.getSouthWest().lng();
  return "/trips/"+trip_id+"/trip_experiences/markers?NELA=" + northEastLat + "&NELO=" + northEastLng + "&SWLA=" + southWestLat + "&SWLO=" + southWestLng ;
}



